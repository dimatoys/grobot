#include "realsense.h"
#include "regression.h"

#include <stdio.h>
#include <math.h>
#include <string.h>
#include <time.h>

long get_diff(struct timespec& start, struct timespec& end) {
	return (end.tv_sec - start.tv_sec) * 1000000000L + (end.tv_nsec - start.tv_nsec);
}

void perfTest() {

	struct timespec start_scan;
	struct timespec image_ready;
	struct timespec drawn;
	struct timespec calibrate;
	struct timespec processed;
	struct timespec visualized;
	struct timespec saved;

	TRealSense src;
	//TDepthFile src("1609729260.csv");

	TCamera camera;

	clock_gettime(CLOCK_REALTIME, &start_scan);

	src.newFrame();
	clock_gettime(CLOCK_REALTIME, &image_ready);

	//camera.calibrate(&src);
	camera.drawDepth(&src);
	clock_gettime(CLOCK_REALTIME, &drawn);

	camera.calibrate4(&src);
	clock_gettime(CLOCK_REALTIME, &calibrate);

	camera.process4(&src);
	clock_gettime(CLOCK_REALTIME, &processed);

	camera.visualize4();
	clock_gettime(CLOCK_REALTIME, &visualized);

	camera.saveJpg();
	FILE *f = fopen("scan.jpg", "wb");
	fwrite(camera.buffer, camera.buffer_ptr, 1, f);
	fclose(f);
	clock_gettime(CLOCK_REALTIME, &saved);


	printf("scan:       %-12.9f\n", (double)get_diff(start_scan, image_ready)/ 1000000000.0);
	printf("draw:       %-12.9f\n", (double)get_diff(image_ready, drawn)/ 1000000000.0);
	printf("calibrate:  %-12.9f\n", (double)get_diff(drawn, calibrate)/ 1000000000.0);
	printf("process:    %-12.9f\n", (double)get_diff(calibrate, processed)/ 1000000000.0);
	printf("visualize:  %-12.9f\n", (double)get_diff(processed, visualized)/ 1000000000.0);
	printf("save:       %-12.9f\n", (double)get_diff(visualized, saved)/ 1000000000.0);
	printf("\ntotal:      %-12.9f\n", (double)get_diff(start_scan, saved)/ 1000000000.0);
}

void surfaceTest1() {
	TRealSense src;
	//TDepthFile src("1609729260.csv");

	TCamera camera;

	src.newFrame();

	camera.drawDepth(&src);
	//camera.calibrate3(&src);
	camera.calibrate4(&src);
	camera.process4(&src);
	camera.visualize4();

	camera.saveJpg();
	FILE *f = fopen("scan.jpg", "wb");
	fwrite(camera.buffer, camera.buffer_ptr, 1, f);
	fclose(f);

}

void smallObjTest() {
	//TRealSense src;
	TDepthFile src("sso2.csv");

	TCamera camera;

	src.newFrame();
	//src.save("sso4.csv");

	camera.drawDepth(&src);
	camera.process5(&src);
	camera.visualize5();

	camera.saveJpg();
	FILE *f = fopen("scan.jpg", "wb");
	fwrite(camera.buffer, camera.buffer_ptr, 1, f);
	fclose(f);

}


int main(int argc, char **argv)
{

	//perfTest();
	//surfaceTest1();
	smallObjTest();
}

/*

285 [2971,2971,2971,2984,2984,2984,2984,2984,2998,2998,2998,2984,2984,2984,2971,2971,2958,2958,2958,2958,2958,2958,2958,2958,2958,2958,2971,2971,2984,2998,3011,3025,3039,3039,3052,3052,3066,3066,3066,3066,3066,3066,3066,3052,3052,3039,3025,3025,3011,3011,2998,2984,2984,2984,2984,2971,2984,2984,2998,2998,3011,3025,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,694,692,690,688,686,684,681,679,677,675,674,672,670,667,664,659,655,0,652,652,652,652,653,653,655,655,657,654,0,0,0,0,0,0,603,602,601,600,598,597,596,595,594,594,593,592,591,589,588,586,585,583,581,579,576,574,571,568,0,0,560,558,556,553,552,549,547,545,541,539,537,535,533,532,530,529,528,527,526,524,524,523,522,521,519,519,517,515,513,510,508,506,505,502,500,498,496,495,493,493,492,490,490,489,487,486,484,483,481,479,477,475,474,473,472,472,470,468,466,464,463,461,459,458,458,457,456,456,455,455,454,454,452,451,450,449,448,446,445,444,442,441,440,438,436,434,433,431,430,429,428,427,426,425,424,423,422,421,420,419,418,417,416,415,414,413,412,411,410,409,408,407,406,405,404,402,401,401,400,399,398,397,396,396,395,394,393,392,391,390,389,388,387,386,384,384,382,382,381,380,379,379,378,377,377,376,375,374,373,372,371,370,369,368,367,366,365,365,364,363,363,362,361,361,360,359,359,358,357,356,355,355,354,353,352,352,351,350,350,349,349,348,347,346,346,345,344,343,342,341,340,340,339,338,337,336,336,335,334,333,333,332,332,331,331,331,330,329,329,328,327,326,326,325,324,323,322,322,321,321,320,320,319,319,318,317,317,316,316,315,314,314,313,313,312,312,311,310,309,309,308,307,307,306,305,305,304,303,303,303,302,302,302,301,301,300,300,299,298,298,297,297,296,296,296,295,294,294,293,293,292,292,291,291,290,290,290,289,289,288,288,287,287,286,286,285,285,284,284,283,283,282,282,281,281,280,279,279,278,277,277,276,276,275,275,275,274,274,274,273,273,272,272,272,271,271,270,270,270,269,269,268,268,267,267,266,266,265,265,264,264,264,263,263,263]
296 [0,0,2581,2581,2581,2581,2581,2591,2601,2611,2622,2632,2642,2642,2632,2632,2622,2611,2581,2561,2551,2551,2571,2591,2611,2622,2642,2674,2696,2706,2706,2717,2717,2729,2729,2717,2717,2706,2696,2696,2696,2717,2729,2751,2774,2797,2821,2857,2881,2906,2919,2932,2945,2945,2945,2958,2958,2958,2971,2971,2984,2998,2998,2998,2998,2998,2971,2958,2932,2906,2881,2857,2833,2821,2809,2809,2833,2845,2857,2894,2919,2945,2945,2958,2971,2971,2971,2971,2971,2971,2971,2958,2958,2945,2932,2919,2906,2894,2857,2833,2809,2797,2774,2785,2797,2809,2833,2869,2932,2984,2998,3011,3011,3011,3011,3011,3011,2998,2998,3011,3011,2984,2958,2945,2932,2919,2906,2906,2919,2919,2945,2971,2998,3011,3052,3066,3109,3153,3183,3214,3245,3277,3293,3326,3326,3342,3342,3342,3342,3326,3293,3245,3199,3168,3124,3081,3039,2998,2958,2932,2906,2894,2906,2932,2971,3011,3052,3095,3124,3168,3199,3199,3214,3214,3214,3214,3214,3214,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,720,720,720,718,716,716,713,0,701,0,692,690,687,685,683,681,679,675,671,668,0,666,666,665,664,664,663,662,659,657,652,646,637,630,624,620,616,612,609,607,605,603,601,599,596,594,592,590,588,586,584,582,581,579,577,574,571,568,565,561,558,556,554,550,547,545,544,542,540,538,536,534,533,532,531,529,528,526,526,524,522,521,519,517,516,515,513,511,510,508,506,503,501,499,497,496,494,493,491,489,487,484,482,480,477,475,473,472,470,469,468,466,465,463,462,460,458,457,456,454,453,452,451,449,448,447,446,444,444,442,441,440,438,437,435,434,433,432,431,430,428,427,426,425,423,421,420,419,417,416,415,414,413,412,411,411,410,409,407,405,404,401,400,399,398,397,396,395,394,393,393,392,391,390,390,389,388,387,386,385,384,382,380,379,378,377,376,375,373,373,372,371,370,370,368,367,366,365,364,363,362,361,360,359,358,358,357,356,355,354,353,352,351,351,350,349,349,349,348,347,347,346,345,344,343,342,341,340,339,338,337,336,335,334,333,332,332,331,330,329,329,328,327,327,326,325,324,324,323,322,321,321,320,319,318,317,317,316,315,315,314,313,313,312,311,311,310,310,309,308,308,308,307,307,307]
270  [0,444,444,444,445,444,445,444,444,444,444,443,442,442,441,440,440,438,438,437,436,435,434,434,433,432,432,431,430,430,429,429,428,427,426,425,424,423,422,421,420,420,419,418,418,417,416,415,415,414,413,413,412,411,411,410,409,409,408,407,406,406,405,404,403,403,402,401,401,400,400,399,399,398,398,397,397,396,395,395,393,393,392,391,390,390,389,388,388,387,387,386,386,385,385,384,384,383,382,382,381,381,380,379,379,378,378,377,377,376,376,376,375,375,375,374,373,373,372,372,371,370,370,369,369,368,368,367,366,365,364,363,363,362,361,361,360,360,359,358,358,358,357,357,357,356,356,355,355,354,353,353,352,352,351,350,350,349,349,348,347,347,346,346,345,345,345,344,344,343,343,342,342,341,341,340,340,340,339,339,338,338,337,337,337,336,336,335,335,334,334,333,333,332,332,331,331,330,330,330,329,329,329,328,328,327,327,326,325,325,324,324,323,322,322,322,321,321,321,320,320,320,320,319,319,319,318,318,318,317,317,316,316,315,315,314,314,313,313,312,312,311,311,310,310,310,309,309,309,308,308,308,307,307,307,306,306,305,305,304,304,303,303,302,302,302,301,301,300,300,300,300,299,299,299,298,298,298,297,297,297,296,296,296,296,295,295,294,294,294,293,293,292,292,291,291,291,290,290,290,289,289,289,289,288,288,288,287,287,286,286,285,285,285,284,284,283,283,282,282,282,281,281,280,280,279,279,279,279,278,278,278,277,277,277,277,276,276,276,276,275,275,275,275,274,274,274,274,273,273,273,272,272,271,271,271,270,270,270,269,269,269,268,268,268,268,267,267,267,267,267,266,266,266,265,265,265,264,264,263,263,263,263,263,263,262,262,262,262,261,261,261,260,260,260,259,259,259,258,258,258,258,257,257,257,256,256,256,255,255,255,254,254,254,254,253,253,253,252,252,252,252,251,251,251,251,250,250,250,250,249,249,249,249,248,248,248,248,248,247,247,247,247,247,246,246,246,246,245,245,245,244,244,244,243,243,243,243,242,242,242,242,241,241,241,241,240,240,240,239,239,239,238,238,238,238,238,237,237,237]
*/
